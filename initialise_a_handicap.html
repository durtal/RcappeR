<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>Initialising a Handicap</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">

	/* padding for bootstrap navbar */
	body {
		padding-top: 20px;
		padding-bottom: 20px;
	}
	@media (max-width: 979px) {
		body {
			padding-top: 0;
		}
	}

	/* offset scroll position for anchor links (for fixed navbar) */
	@media (min-width: 980px) {
		.section h2 {
			padding-top: 52px;
			margin-top: -52px;
		}
		.section h3 {
			padding-top: 52px;
			margin-top: -52px;
		}
	}

	p {
		font-size: 13px;
	}

	/* don't use link color in navbar */
	.dropdown-menu>li>a {
		color: black;
	}

	/* some padding for disqus */
	#disqus_thread {
		margin-top: 45px;
	}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<h1>RcappeR</h1>
<nav class="navbar navbar-inverse">
	<div class="container-fluid">
		<div class="navbar-header">
			<button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle Navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a href="https://github.com/durtal" class="navbar-brand">durtal@github</a>
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li>
					<a href="index.html">RcappeR home</a>
				</li>
				<li>
					<a href="functions.html">Functions</a>
				</li>
				<li class="dropdown">
					<a href="datasets" class="dropdown-toggle" data-toggle="dropdown">
						Datasets <b class="caret"></b>
					</a>
					<ul class="dropdown-menu">
						<li>
							<a href="gulfstream.html">gulfstream</a>
						</li>
						<li>
							<a href="bhascale.html">bhascale</a>
						</li>
						<li>
							<a href="example_race.html">example_race</a>
						</li>
					</ul>
				</li>
				<li class="dropdown">
					<a href="vignettes" class="dropdown-toggle" data-toggle="dropdown">
						Vignettes <b class="caret"></b>
					</a>
					<ul class="dropdown-menu">
						<li>
							<a href="data_cleaning.html">Data Cleaning</a>
						</li>
						<li>
							<a href="data_prep.html">Data Preparation</a>
						</li>
						<li>
							<a href="handicap_with_zipf_race.html">(zipf_race)</a>
						</li>
						<li>
							<a href="handicap_with_zipf_hcp.html">Handicapping (zipf_hcp)</a>
						</li>
						<li>
							<a href="initialise_a_handicap.html">Initialise Handicap (zipf_init)</a>
						</li>
					</ul>
				</li>
				<li class="dropdown">
					<a href="blog" class="dropdown-toggle" data-toggle="dropdown">
						Blog <b class="caret"></b>
					</a>
					<ul class="dropdown-menu">
						<li>
							<a href="wild_data_example.html">Wild Horse Racing Data</a>
						</li>
					</ul>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a href="https://github.com/durtal/RcappeR"><small>repo</small></a></li>
			</ul>
		</div>
	</div>
</nav>

<div id="header">
<h1 class="title">Initialising a Handicap</h1>
</div>


<p>This vignette walks through the use of <code>zipf_init</code>, which initialises a handicap using a collection of races, in this case the <strong>gulfstream</strong> dataset (used in <a href="data_prep.html"><strong>Data Preparation</strong></a> vignettes). There are certain steps necessary ahead of using <code>zipf_init</code>, these are covered in the <strong>Data Preparation</strong> vignette, but will be covered again here.</p>
<div id="gulfstream-dataset" class="section level2">
<h2>gulfstream Dataset</h2>
<p>Load the dataset:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(gulfstream)</code></pre>
<p>The <strong>gulfstream</strong> dataset contains 324 unique races, this is not a huge number, the more races the better. A look at the structure of <strong>gulfstream</strong>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(gulfstream)</code></pre>
<pre><code>## &#39;data.frame&#39;:    2863 obs. of  17 variables:
##  $ date     : chr  &quot;01/01/13&quot; &quot;01/01/13&quot; &quot;01/01/13&quot; &quot;01/01/13&quot; ...
##  $ race     : int  1 1 1 1 1 1 1 1 2 2 ...
##  $ race_type: chr  &quot;mdn clm&quot; &quot;mdn clm&quot; &quot;mdn clm&quot; &quot;mdn clm&quot; ...
##  $ dist     : int  6 6 6 6 6 6 6 6 6 6 ...
##  $ surf     : chr  &quot;dirt&quot; &quot;dirt&quot; &quot;dirt&quot; &quot;dirt&quot; ...
##  $ value    : int  17500 17500 17500 17500 17500 17500 17500 17500 17500 17500 ...
##  $ going    : chr  &quot;fast&quot; &quot;fast&quot; &quot;fast&quot; &quot;fast&quot; ...
##  $ trainer  : chr  &quot;nicholas gonzalez&quot; &quot;anthony pecoraro&quot; &quot;edwin t broome&quot; &quot;edward plesa jr&quot; ...
##  $ jockey   : chr  &quot;jermaine bridgmohan&quot; &quot;joseph rocco jr&quot; &quot;gabriel saez&quot; &quot;elvis trujillo&quot; ...
##  $ j_clm    : int  0 0 0 0 5 0 7 0 0 0 ...
##  $ age      : int  3 3 3 3 3 3 3 3 3 3 ...
##  $ wgt      : int  122 122 122 122 117 122 115 122 122 122 ...
##  $ gate     : int  6 1 8 7 5 2 4 3 2 4 ...
##  $ pos      : int  1 2 3 4 5 6 7 8 1 2 ...
##  $ horse    : chr  &quot;don&#39;tgetmestarted&quot; &quot;dream of scipio&quot; &quot;beltram&quot; &quot;gold bitten tiger&quot; ...
##  $ fintime  : num  72.4 74.2 74.5 74.7 74.7 ...
##  $ sect_4f  : num  47 47.1 47.4 48.4 47.4 ...</code></pre>
</div>
<div id="handicapping-preparation" class="section level1">
<h1>Handicapping preparation</h1>
<p>In order to use some of the more complex functions (<code>zipf_init</code>, <code>zipf_hcp</code>) a certain amount of preparation is required. There are a number of variables needed for handicapping, these are:</p>
<ul>
<li>unique race id (a way to distinguish different races)</li>
<li>race classes, or types</li>
<li>surface</li>
<li>distance</li>
<li>final times
<ul>
<li>either times for all runners, or</li>
<li>a winning time and a way to calculate final times (beaten seconds, or beaten lengths)</li>
</ul></li>
<li>weight carried</li>
</ul>
<p>The variables above should be pretty common in a racing dataset that you wish to calculate ratings from. In the <strong>gulfstream</strong> dataset we have all the above. Individual final times for horses might be a hurdle, but lengths beaten is a much more common variable, and as covered in the <a href="data_cleaning.html"><strong>Data Cleaning</strong></a> vignette, the <code>conv_margins</code> can convert lengths beaten into final times.</p>
<p>A unique race id is required in the <strong>gulfstream</strong> dataset, but this can be created by concatenating the <code>date</code> and <code>race</code> variables. Obviously if a dataset contains races at more than one racecourse, it would be wise to include something about that: you can’t have two races being run at the same track, on the same day at the same time. Let’s create a variable called <code>date_race</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r">gulfstream$date_race &lt;-<span class="st"> </span><span class="kw">paste</span>(gulfstream$date, gulfstream$race, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)</code></pre>
<p>The above <code>date_race</code> variable was the only one missing from the above list, but before handicapping can begin we need to calculate margins between horses that take into account the following:</p>
<ul>
<li>distance</li>
<li>surface</li>
<li>beaten margins</li>
<li>weight carried</li>
</ul>
<p>The best (imo) way to do this is to use the package <code>dplyr</code> which takes advantage of the <code>%&gt;%</code> pipe function from <code>magrittr</code> to calculate the necessary variables. The code below processes the gulfstream dataset, creating the necessary variables. It is explained in more detail below the code, the functions used from <strong>RcappeR</strong> are <code>btn_sec</code>, <code>lbs_per_sec</code> and <code>diff_at_wgts</code>:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
new_gulfstream &lt;-<span class="st"> </span>gulfstream %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(date_race) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">btn_sec =</span> <span class="kw">btn_sec</span>(fintime),
           <span class="dt">scale =</span> <span class="kw">lbs_per_sec</span>(<span class="dt">dist =</span> dist, <span class="dt">surf =</span> <span class="st">&quot;dirt&quot;</span>),
           <span class="dt">btn_lbs =</span> scale *<span class="st"> </span>btn_sec,
           <span class="dt">diff_wgts =</span> <span class="kw">diff_at_wgts</span>(<span class="dt">btn_lbs =</span> btn_lbs, <span class="dt">wgt_carried =</span> wgt))</code></pre>
<ol style="list-style-type: decimal">
<li>Load dplyr library
<ul>
<li><code>library(dplyr)</code></li>
</ul></li>
<li>Use gulfstream dataset and store results back in gulfstream
<ul>
<li><code>gulfstream &lt;- gulfstream %&gt;%</code></li>
</ul></li>
<li>Group races by the unique race ids (date_race)
<ul>
<li><code>group_by(date_race)</code></li>
</ul></li>
<li>Create new variables within each group (each race)
<ul>
<li>calculate margins (in seconds) between horses
<ul>
<li><code>btn_sec = btn_sec(fintime),</code></li>
</ul></li>
<li>calculate lbs per second scale
<ul>
<li><code>scale = lbs_per_sec(dist = dist, surf = &quot;dirt&quot;),</code></li>
</ul></li>
<li>calculate beaten lbs
<ul>
<li><code>btn_lbs = scale * btn_sec,</code></li>
</ul></li>
<li>calculate difference at the weights (margins, and weight carried)
<ul>
<li><code>diff_at_wtgs(btn_lbs = btn_lbs, wgt_carried = wgt))</code></li>
</ul></li>
</ul></li>
</ol>
<p>At this stage, the <strong>gulfstream</strong> dataset can be entered into <code>zipf_init</code>. First a word about the methodology for initialising the handicap.</p>
<div id="handicapping-methodology" class="section level2">
<h2>Handicapping methodology</h2>
<p>The handicapping methodology uses a version of race standardisation first explained by Simon Rowlands, Head of Research at Timeform, specifically using Zipfs Law (hence the names of this family of functions, see also <code>?zipf_race</code> and <code>?zipf_hcp</code>).</p>
<p>Race standardisation looks at races of similar class/type and assesses the performance of one winner, by assessing the performance of winners in the different, but similar, races. A more detailed explanation can be found in the <a href="handicap_with_zipf_race.html"><strong>Handicap with zipf_race</strong></a> vignette, which walks through a simple example using the <code>zipf_race</code> function, which is called by <code>zipf_init</code> (and <code>zipf_hcp</code>).</p>
</div>
<div id="initialising-a-handicap---zipf_init" class="section level2">
<h2>Initialising a handicap - zipf_init</h2>
<p>Race standardisation uses past ratings from similar types/classes of race to assess a new race, in initialising a handicap there are no past ratings. So the <code>zipf_init</code> function group races together and assess performances using margins between horses - the <code>diff_wgts</code> variable created above. This process builds a skeleton handicap, from which further handicapping can, and should, be undertaken.</p>
<p>Below is a simple table explaining the various inputs to <code>zipf_init</code>:</p>
<table>
<thead>
<tr class="header">
<th align="left">param</th>
<th align="left">details</th>
<th align="left">example input</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">races</td>
<td align="left">a dataframe of races</td>
<td align="left"><code>new_gulfstream</code></td>
</tr>
<tr class="even">
<td align="left">group_by</td>
<td align="left">name(s) of variables to group races by</td>
<td align="left"><code>&quot;race_type&quot;</code> (could also include <code>value</code>)</td>
</tr>
<tr class="odd">
<td align="left">race_id</td>
<td align="left">name of variable to identify the unique races in the <code>races</code> dataframe</td>
<td align="left"><code>&quot;date_race&quot;</code></td>
</tr>
<tr class="even">
<td align="left">btn_var</td>
<td align="left">name of variable containing margins between horses in <code>races</code> dataframe</td>
<td align="left"><code>&quot;diff_wgts&quot;</code></td>
</tr>
<tr class="odd">
<td align="left">.progress</td>
<td align="left">plyr’s progress bar, useful when using on large datasets (&gt;20k rows) as the function takes time to run</td>
<td align="left">“text”</td>
</tr>
</tbody>
</table>
<p>So:</p>
<pre class="sourceCode r"><code class="sourceCode r">our_hcp &lt;-<span class="st"> </span><span class="kw">zipf_init</span>(<span class="dt">races =</span> new_gulfstream, <span class="dt">group_by =</span> <span class="st">&quot;race_type&quot;</span>, <span class="dt">race_id =</span> <span class="st">&quot;date_race&quot;</span>, <span class="dt">btn_var =</span> <span class="st">&quot;diff_wgts&quot;</span>, <span class="dt">.progress =</span> <span class="st">&quot;text&quot;</span>)</code></pre>
<p>This small example, handicapping 324 races, split into 2 different race types (mdn clm, clm), took 15.4092572 seconds.</p>
<p>The output from <code>zipf_init</code> is a list (of class “rcapper_zipf_init”), there are print and summary methods for this class of object (though both do the same):</p>
<pre class="sourceCode r"><code class="sourceCode r">our_hcp</code></pre>
<pre><code>## Initial handicap using zipf_init:
## 
## No. of races:
##   324 
## Race Groups:
##   clm, mdn clm 
## Counts:
##     clm mdn clm 
##     196     128 
## 
## Ratings Summary:
##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## -14.8700  -5.3490  -0.7219   0.0000   4.0890  26.5300</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(our_hcp)</code></pre>
<pre><code>## Initial handicap using zipf_init:
## 
## No. of races:
##   324 
## Race Groups:
##   clm, mdn clm 
## Counts:
##     clm mdn clm 
##     196     128 
## 
## Ratings Summary:
##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## -14.8700  -5.3490  -0.7219   0.0000   4.0890  26.5300</code></pre>
<p>There is also a plot method, perhaps the most useful, which plots the distribution of ratings for each group, as we can see below the small samples in a couple of the race types shows the need for more races, or at least making sure groups are of a decent size.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(our_hcp)</code></pre>
<p><img src="initialise_a_handicap_files/figure-html/unnamed-chunk-9-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<p>The plot shows a distribution of ratings (in lbs) for the winners in the 324 races in <code>new_gulfstream</code> dataset. The mean will always be around 0, for all race types. The next step is to assign a standard rating for a winner of this type/class of race. These standards should reflect the difference in ability (in lbs) between the different race types, so a standard rating for Grade 1 winner is going to be far greater than that of a Maiden race, what these differences are is unknown - I am working on a solution to help find these differences.</p>
<p>Possible solutions to this issue is to use ratings from other handicappers to help guide this process, for example, Timeform (including Timeform US) or Beyer class pars.</p>
<p>Finally, <code>merge_zipf_init</code> function will merge the resulting ratings from <code>zipf_init</code> with the dataset used to calculate the ratings. Finally print the first 20 rows, showing the variables created in this vignette and the zipf_rtg for runners:</p>
<pre class="sourceCode r"><code class="sourceCode r">initial_hcp &lt;-<span class="st"> </span><span class="kw">merge_zipf_init</span>(<span class="dt">zipf_list =</span> our_hcp, <span class="dt">races =</span> new_gulfstream, <span class="dt">btn_var =</span> <span class="st">&quot;diff_wgts&quot;</span>)
<span class="co"># Let&#39;s have a look at the first few rows of our skeleton handicap</span>
initial_hcp %&gt;%
<span class="st">    </span><span class="kw">select</span>(race_type, date_race, pos, fintime, btn_sec:zipf_rtg) %&gt;%
<span class="st">    </span><span class="kw">head</span>(<span class="dv">15</span>)</code></pre>
<pre><code>##    race_type  date_race pos fintime btn_sec scale  btn_lbs diff_wgts
## 1    mdn clm 01/01/13_1   1   72.43    0.00 17.00   0.0000    0.0000
## 2    mdn clm 01/01/13_1   2   74.18    1.75 17.00  29.7500   29.7500
## 3    mdn clm 01/01/13_1   3   74.54    2.11 17.00  35.8700   35.8700
## 4    mdn clm 01/01/13_1   4   74.65    2.22 17.00  37.7400   37.7400
## 5    mdn clm 01/01/13_1   5   74.68    2.25 17.00  38.2500   43.2500
## 6    mdn clm 01/01/13_1   6   75.08    2.65 17.00  45.0500   45.0500
## 7    mdn clm 01/01/13_1   7   75.77    3.34 17.00  56.7800   63.7800
## 8    mdn clm 01/01/13_1   8   78.60    6.17 17.00 104.8900  104.8900
## 9        clm 01/02/13_1   1   98.72    0.00 11.76   0.0000    0.0000
## 10       clm 01/02/13_1   2   98.75    0.03 11.76   0.3528    0.3528
## 11       clm 01/02/13_1   3  100.30    1.58 11.76  18.5808   18.5808
## 12       clm 01/02/13_1   4  101.08    2.36 11.76  27.7536   27.7536
## 13       clm 01/02/13_1   5  101.28    2.56 11.76  30.1056   34.1056
## 14       clm 01/02/13_1   6  118.72   20.00 11.76 235.2000  235.2000
## 15   mdn clm 01/02/13_2   1   73.65    0.00 17.00   0.0000    0.0000
##    zipf_rtg
## 1     12.31
## 2    -17.44
## 3    -23.56
## 4    -25.43
## 5    -30.94
## 6    -32.74
## 7    -51.47
## 8    -92.58
## 9     15.15
## 10    14.80
## 11    -3.43
## 12   -12.60
## 13   -18.96
## 14  -220.05
## 15     3.56</code></pre>
<a href="https://github.com/durtal/RcappeR" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#d9230f; color:#fcfcfc; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</div>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
