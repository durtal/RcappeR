<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>wild data</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">

	/* padding for bootstrap navbar */
	body {
		padding-top: 20px;
		padding-bottom: 20px;
	}
	@media (max-width: 979px) {
		body {
			padding-top: 0;
		}
	}

	/* offset scroll position for anchor links (for fixed navbar) */
	@media (min-width: 980px) {
		.section h2 {
			padding-top: 52px;
			margin-top: -52px;
		}
		.section h3 {
			padding-top: 52px;
			margin-top: -52px;
		}
	}

	p {
		font-size: 13px;
	}

	/* don't use link color in navbar */
	.dropdown-menu>li>a {
		color: black;
	}

	/* some padding for disqus */
	#disqus_thread {
		margin-top: 45px;
	}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<h1>RcappeR</h1>
<nav class="navbar navbar-inverse">
	<div class="container-fluid">
		<div class="navbar-header">
			<button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle Navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a href="https://github.com/durtal" class="navbar-brand">durtal@github</a>
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li>
					<a href="index.html">RcappeR home</a>
				</li>
				<li>
					<a href="functions.html">Functions</a>
				</li>
				<li class="dropdown">
					<a href="datasets" class="dropdown-toggle" data-toggle="dropdown">
						Datasets <b class="caret"></b>
					</a>
					<ul class="dropdown-menu">
						<li>
							<a href="gulfstream.html">gulfstream</a>
						</li>
						<li>
							<a href="bhascale.html">bhascale</a>
						</li>
						<li>
							<a href="example_race.html">example_race</a>
						</li>
					</ul>
				</li>
				<li class="dropdown">
					<a href="vignettes" class="dropdown-toggle" data-toggle="dropdown">
						Vignettes <b class="caret"></b>
					</a>
					<ul class="dropdown-menu">
						<li>
							<a href="data_cleaning.html">Data Cleaning</a>
						</li>
						<li>
							<a href="data_prep.html">Data Preparation</a>
						</li>
						<li>
							<a href="handicap_with_zipf_race.html">(zipf_race)</a>
						</li>
						<li>
							<a href="handicap_with_zipf_hcp.html">Handicapping (zipf_hcp)</a>
						</li>
						<li>
							<a href="initialise_a_handicap.html">Initialise Handicap (zipf_init)</a>
						</li>
					</ul>
				</li>
				<li class="dropdown">
					<a href="blog" class="dropdown-toggle" data-toggle="dropdown">
						Blog <b class="caret"></b>
					</a>
					<ul class="dropdown-menu">
						<li>
							<a href="wild_data_example.html">Wild Horse Racing Data</a>
						</li>
					</ul>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li><a href="https://github.com/durtal/RcappeR"><small>repo</small></a></li>
			</ul>
		</div>
	</div>
</nav>

<div id="header">
<h1 class="title">wild data</h1>
</div>


<p>This lengthy vignette looks at using the <code>RcappeR</code> on some <em>wild</em> horse racing data found in this <a href="https://github.com/maithuvenkatesh/University-Project">github repo</a>. This vignette, created on 2015-09-24, has emphasised that the package is in development, and the need for more functionality to aid the cleaning and preparation of racing data. So the package will be improved on over time, but where I’ve bumped into an cleaning/preparation issue here I’ve created a quick and dirty hacks to solve them.</p>
<p>The vignette will walk through reducing the dataset to a subset of races, cleaning a number of variables necessary for analysis and handicapping, before preparing data ahead of initialising a very simple handicap using <code>zipf_init</code> and finally showing the use of <code>zipf_hcp</code>.</p>
<div id="load-libraries-and-data" class="section level4">
<h4>Load libraries and data</h4>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(RcappeR)
<span class="kw">library</span>(dplyr)     <span class="co"># for speedy manipulation of dataframes</span>
<span class="kw">library</span>(magrittr)  <span class="co"># for %&lt;&gt;%</span>
<span class="kw">library</span>(stringr)   <span class="co"># for manipulating strings</span>
<span class="kw">library</span>(ggplot2)   <span class="co"># for plotting</span></code></pre>
<p>Now load the csv file, and view its structure.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># working on windows I couldn&#39;t use read.csv inside an .Rmd file, so used answer from</span>
<span class="co"># http://stackoverflow.com/questions/19890633/r-produces-unsupported-url-scheme-error-when-getting-data-from-https-sites</span>

df &lt;-<span class="st"> </span>RCurl::<span class="kw">getURL</span>(<span class="dt">url =</span> <span class="st">&quot;https://raw.githubusercontent.com/maithuvenkatesh/University-Project/master/Data/born98.csv&quot;</span>,
               <span class="dt">ssl.verifypeer =</span> 0L, <span class="dt">followlocation =</span> 1L)
df &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="dt">text =</span> df, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">sep =</span> <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
<span class="kw">str</span>(df)</code></pre>
<pre><code>## &#39;data.frame&#39;:    56730 obs. of  26 variables:
##  $ race_date            : chr  &quot;2003-09-28&quot; &quot;2003-09-28&quot; &quot;2001-06-19&quot; &quot;2001-06-19&quot; ...
##  $ race_time            : chr  &quot;15:10:00&quot; &quot;15:10:00&quot; &quot;15:05:00&quot; &quot;15:05:00&quot; ...
##  $ track                : chr  &quot;Ascot&quot; &quot;Ascot&quot; &quot;Ascot&quot; &quot;Ascot&quot; ...
##  $ race_name            : chr  &quot;Riggs Bank Rated Stakes &quot; &quot;Riggs Bank Rated Stakes &quot; &quot;Kings Stand Stakes &quot; &quot;Kings Stand Stakes &quot; ...
##  $ race_restrictions_age: chr  &quot;3yo+&quot; &quot;3yo+&quot; &quot;3yo+&quot; &quot;3yo+&quot; ...
##  $ race_class           : chr  &quot;Class 2&quot; &quot;Class 2&quot; &quot;Class 1&quot; &quot;Class 1&quot; ...
##  $ major                : chr  &quot;&quot; &quot;&quot; &quot;Group 2&quot; &quot;Group 2&quot; ...
##  $ race_distance        : chr  &quot;5f &quot; &quot;5f &quot; &quot;5f &quot; &quot;5f &quot; ...
##  $ prize_money          : int  12835 12835 81000 81000 81000 81000 81000 81000 5538 78300 ...
##  $ going_description    : chr  &quot;Firm&quot; &quot;Firm&quot; &quot;Good&quot; &quot;Good&quot; ...
##  $ number_of_runners    : int  16 16 22 22 22 22 22 22 12 15 ...
##  $ place                : chr  &quot;6th&quot; &quot;14th&quot; &quot;9th&quot; &quot;11th&quot; ...
##  $ distbt               : chr  &quot;HD&quot; &quot;5&quot; &quot;SH&quot; &quot;HD&quot; ...
##  $ horse_name           : chr  &quot;My American Beauty&quot; &quot;Talbot Avenue&quot; &quot;Danehurst&quot; &quot;Dietrich (USA)&quot; ...
##  $ stall                : int  19 16 14 21 11 6 20 10 7 1 ...
##  $ trainer              : chr  &quot;Easterby, T D&quot; &quot;Mullineaux, M&quot; &quot;Prescott, Sir Mark&quot; &quot;OBrien, A P&quot; ...
##  $ horse_age            : int  5 5 3 3 3 3 3 3 3 4 ...
##  $ jockey_name          : chr  &quot;Fanning, Joe&quot; &quot;Fallon, K&quot; &quot;Duffield, G&quot; &quot;Kinane, M J&quot; ...
##  $ jockeys_claim        : int  0 0 0 0 0 0 0 0 0 0 ...
##  $ pounds               : int  119 121 119 119 122 122 119 119 134 128 ...
##  $ odds                 : num  33 14 10 10 100 20 50 20 4.5 66 ...
##  $ fav                  : chr  &quot;&quot; &quot;&quot; &quot;&quot; &quot;&quot; ...
##  $ official_rating      : int  86 88 109 0 87 0 110 120 76 108 ...
##  $ comptime             : chr  &quot;1 mins 0.49s&quot; &quot;1 mins 0.49s&quot; &quot;1 mins 0.49s&quot; &quot;1 mins 0.49s&quot; ...
##  $ TotalDstBt           : chr  &quot;5.15&quot; &quot;12.7&quot; &quot;3.25&quot; &quot;3.85&quot; ...
##  $ X                    : logi  NA NA NA NA NA NA ...</code></pre>
<p>So the dataset consists of 56730 rows and 26 columns. From a quick inspection a number of important variables exist that will help to identify the unique races within the dataset, namely <code>race_date</code>, <code>race_time</code> and <code>track</code> (the <code>race_name</code> could be included as well, although some races could have the same name so shouldn’t be used on its own).</p>
</div>
<div id="reducing-dataset" class="section level4">
<h4>Reducing dataset</h4>
<p>Ideally every unique race in the dataset will have every runner that competed in that race, a way to check this is to use the <code>number_of_runners</code> variable and a count of the number of rows that belong to a unique race. The following code, groups races together using the aforementioned variables, creates a new variable (<code>n</code>) that counts the number of rows, and then filters those rows where <code>n</code> == <code>number_of_runners</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">races &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(race_date, race_time, track) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">n =</span> <span class="kw">n</span>()) %&gt;%
<span class="st">    </span><span class="kw">filter</span>(n ==<span class="st"> </span>number_of_runners)</code></pre>
<p>The new dataset has 14494 rows. The <code>RcappeR</code> package also doesn’t truly cater for National Hunt racing (see <code>?lbs_per_sec</code>), so those races need to be excluded. It’s not immediately obvious how to do this from the available variables, but the <code>stall</code> variable will suffice, horses running National Hunt races don’t start in a stall, these horses begin in “stall” 0 in the dataset. A quick look at races where horses start in stall 0, reveals they are Novice Hurdle races.</p>
<pre class="sourceCode r"><code class="sourceCode r">races %&gt;%<span class="st"> </span><span class="kw">filter</span>(stall ==<span class="st"> </span><span class="dv">0</span>) %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(race_date, race_time, track, race_name) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">n</span>()) %&gt;%
<span class="st">    </span><span class="kw">select</span>(race_name, n)</code></pre>
<pre><code>## Source: local data frame [3 x 5]
## Groups: race_date, race_time, track
## 
##    race_date race_time   track                                race_name  n
## 1 2001-08-03  14:25:00  Bangor       Hollybush Juvenile Novices Hurdle  10
## 2 2001-08-27  14:15:00 Cartmel Lakeland Health Juvenile Novices Hurdle   8
## 3 2001-10-11  15:10:00  Ludlow Discover Racing Juvenile Novices Hurdle   7</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span><span class="kw">filter</span>(stall !=<span class="st"> </span><span class="dv">0</span>)</code></pre>
<p>Now the dataset (should hopefully) consist of purely flat races, the task of cleaning can begin.</p>
</div>
<div id="cleaning" class="section level4">
<h4>Cleaning</h4>
<p>The majority of variables should be self explanatory, however they are not in the nicest formats. For example <code>comptime</code> is the final time of the winner of a race in a character format, which is quite useless.</p>
<pre><code>## [1] &quot;1 mins 2.75s&quot; &quot;1 mins 3.18s&quot; &quot;1 mins 2.86s&quot; &quot;1 mins 4.61s&quot;
## [5] &quot;1 mins 0.46s&quot; &quot;0 mins 58.5s&quot;</code></pre>
<p>The <code>conv_times</code> function from <strong>RcappeR</strong> will clean these times, returning a time in seconds. These times are immediately more pliable and can be plotted (using the custom <strong>RcappeR</strong> ggplot theme <code>theme_rcapper()</code>).</p>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">wintime =</span> <span class="kw">conv_times</span>(<span class="dt">times =</span> comptime))
<span class="kw">head</span>(<span class="kw">unique</span>(races$wintime))</code></pre>
<pre><code>## [1] 62.75 63.18 62.86 64.61 60.46 58.50</code></pre>
<p><img src="wild_data_example_files/figure-html/unnamed-chunk-7-1.png" title="" alt="" width="480" style="display: block; margin: auto;" /></p>
<p>The <code>place</code> variable requires cleaning, these are currently stored as strings, in order to cater for horses who were pulled up, unseated rider, etc. The letters are removed from each place string, and are converted to numeric, so those horses pulled up (“PU”), etc, are recorded as NA’s, these horses can be removed for handicapping purposes.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(races$place)</code></pre>
<pre><code>## 
## 10th 11th 12th 13th 14th 15th 16th 17th 18th 19th  1st 20th 21st 22nd 23rd 
##  717  581  474  352  275  235  182  136  104   66 1388   55   42   30   18 
## 24th 25th 26th 27th 28th 29th  2nd 30th  3rd  4th  5th  6th  7th  8th  9th 
##   13    8    6    6    5    5 1385    2 1389 1378 1321 1236 1128 1009  868 
##   BD  DSQ    F  LFT   PU   RO   RR   SU   UR 
##    2   10    1    5   17    1    2    3   14</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">races$place %&lt;&gt;%<span class="st"> </span><span class="kw">str_replace_all</span>(<span class="dt">pattern =</span> <span class="st">&quot;[[:alpha:]]&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">as.numeric</span>()

<span class="kw">table</span>(races$place, <span class="dt">useNA =</span> <span class="st">&quot;ifany&quot;</span>)</code></pre>
<pre><code>## 
##    1    2    3    4    5    6    7    8    9   10   11   12   13   14   15 
## 1388 1385 1389 1378 1321 1236 1128 1009  868  717  581  474  352  275  235 
##   16   17   18   19   20   21   22   23   24   25   26   27   28   29   30 
##  182  136  104   66   55   42   30   18   13    8    6    6    5    5    2 
## &lt;NA&gt; 
##   55</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(place))</code></pre>
<p>The next variable that requires cleaning are the <code>distbt</code> and <code>TotalDstBt</code> variables, the former is lengths between runners, while the latter is cumulative lengths (so lengths behind the winner). Both are strings that contain abbreviations such as “SH” (short head), “HD” (head), and can be converted to a numeric using the <code>conv_len</code> function. It is not important which variable is converted, either can be used in future.</p>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">btn_l =</span> <span class="kw">conv_len</span>(<span class="dt">lengths =</span> distbt),
                  <span class="dt">cum_btn_l =</span> <span class="kw">conv_len</span>(<span class="dt">lengths =</span> TotalDstBt))

races %&gt;%<span class="st"> </span><span class="kw">filter</span>(place !=<span class="st"> </span><span class="dv">1</span>) %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> cum_btn_l, <span class="dt">y =</span> ..density..)) +<span class="st"> </span>
<span class="st">        </span><span class="kw">geom_histogram</span>(<span class="dt">binwidth =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="st">&quot;#D9220F&quot;</span>) +
<span class="st">        </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Cumulative Beaten Lengths&quot;</span>) +
<span class="st">        </span><span class="kw">theme_rcapper</span>()</code></pre>
<p><img src="wild_data_example_files/figure-html/unnamed-chunk-9-1.png" title="" alt="" width="480" style="display: block; margin: auto;" /></p>
<p>The <code>race_distance</code> variable is also in need of cleaning, it contains miles, half miles as Unicode characters, and furlongs. <strong>RcappeR</strong> doesn’t have a function to convert distances from “miles-furlongs-yards” into “furlongs” (the required unit of measure if using <code>lbs_per_sec</code>), so a quick hack has been written for this post, but a more robust <code>conv_dist</code> function should be added to the package. The function is not show here, but can be viewed in the .Rmd <a href="https://github.com/durtal/RcappeR/blob/gh-pages/wild_data_example.Rmd">source</a>.</p>
<pre><code>##  [1] &quot;5f &quot;    &quot;5&lt;U+00BD&gt;f &quot; &quot;6f &quot;    &quot;6&lt;U+00BD&gt;f &quot; &quot;7f &quot;    &quot;7&lt;U+00BD&gt;f &quot; &quot;1m &quot;   
##  [8] &quot;1m&lt;U+00BD&gt;f &quot; &quot;1m1f &quot;  &quot;1m1&lt;U+00BD&gt;f &quot; &quot;1m2f &quot;  &quot;1m2&lt;U+00BD&gt;f &quot; &quot;1m3f &quot;  &quot;1m3&lt;U+00BD&gt;f &quot;
## [15] &quot;1m4f &quot;  &quot;1m4&lt;U+00BD&gt;f &quot; &quot;1m6f &quot;  &quot;1m6&lt;U+00BD&gt;f &quot;</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">dist =</span> <span class="kw">tmp_fun</span>(race_distance))
<span class="kw">unique</span>(races$dist)</code></pre>
<pre><code>##  [1]  5.0  5.5  6.0  6.5  7.0  7.5  8.0  8.5  9.0  9.5 10.0 10.5 11.0 11.5
## [15] 12.0 12.5 14.0 14.5</code></pre>
</div>
<div id="handicapping-preparation" class="section level4">
<h4>Handicapping Preparation</h4>
<p>With the cleaning done, and variables in much more workable formats, some preparation ahead of handicapping/analysis can be carried out. As covered in the <a href="http://durtal.github.io/RcappeR/data_prep.html">Handicapping Preparation</a> vignette, we have a number of important variables available to us:</p>
<ul>
<li>unique race ids (using <code>race_date</code>, <code>race_time</code> and <code>track</code>)</li>
<li>race classes (<code>race_class</code>)</li>
<li>race distance (<code>dist</code> in furlongs)</li>
<li>final times (<code>wintime</code>, which will allow us to calculate final times for all runners using <code>cum_btn_l</code> or <code>btn_l</code>)</li>
<li>weight carried (<code>pounds</code>)</li>
</ul>
<p>The first thing to do is to calculate final times for all runners using the winning time in a race (<code>wintime</code>) and the margins between horses in lengths (either <code>btn_l</code> or <code>cum_btn_l</code>). The BHA (British Horse-Racing Authority), under whose jurisdiction these races were run, uses a different lengths per second scale depending on race conditions (namely going and type of race - Flat or NH, see <code>?bhasale</code>). The <strong>RcappeR</strong> function <code>conv_margins</code> can account for these differences, however the conditions must be an abbreviated form of the going and type of race, which I’m not going to create here - but a function will be written for <strong>RcappeR</strong> to convert the different goings, such as Good To Firm, Standard, Good To Yielding into the correct abbreviations. The default lengths per second value used in the <code>conv_margins</code> function is 5, which is used here.</p>
<p>The following code calculates final times for all runners using the <code>wintime</code> and <code>cum_btn_l</code> variables, as well as beaten seconds. The second chunk of code uses the <code>btn_l</code> variable and the <code>wintime</code>, which requires a bit more code as runners in a race must be grouped and arranged in position order (so cumulative lengths beaten can be calculated). The final times of all runners are then plotted, the different peaks belonging to the different race distances.</p>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">fintime =</span> <span class="kw">conv_margins</span>(<span class="dt">btn_l =</span> cum_btn_l, <span class="dt">win_time =</span> wintime),
                  <span class="dt">btn_sec =</span> <span class="kw">conv_margins</span>(<span class="dt">btn_l =</span> cum_btn_l))

## if only btn_l variable existed
<span class="co"># races %&lt;&gt;%</span>
<span class="co">#     group_by(race_date, race_time, track) %&gt;%</span>
<span class="co">#     arrange(place) %&gt;%</span>
<span class="co">#     mutate(fintime = conv_margins(btn_l = btn_l, cum_l = FALSE, win_time = wintime))</span>

<span class="kw">ggplot</span>(races, <span class="kw">aes</span>(<span class="dt">x =</span> fintime)) +
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">binwidth =</span> .<span class="dv">5</span>, <span class="dt">fill =</span> <span class="st">&quot;#D9220F&quot;</span>) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Final Times (all runners)&quot;</span>) +
<span class="st">    </span><span class="kw">theme_rcapper</span>()</code></pre>
<p><img src="wild_data_example_files/figure-html/unnamed-chunk-13-1.png" title="" alt="" width="480" style="display: block; margin: auto;" /></p>
<p>The next step in handicapping process is to calculate the lbs between runners using the <code>lbs_per_sec</code> function, which accounts for race distance and surface, for this simple example I will elimate all All-Weather races using the <code>going_description</code>, removing “Standard” and “Slow” goings. The code that follows calculates a lbs per second scale (<code>scale</code>), and uses that to calculate beaten lbs (<code>btn_lbs</code>). (the <code>lbs_per_sec</code> function will eventually be improved to account for the speed at which a horse ran it’s race.)</p>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">grepl</span>(<span class="st">&quot;Standard|Slow&quot;</span>, going_description, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))

races %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">scale =</span> <span class="kw">lbs_per_sec</span>(<span class="dt">dist =</span> dist, <span class="dt">surf =</span> <span class="st">&quot;turf&quot;</span>),
                  <span class="dt">btn_lbs =</span> scale *<span class="st"> </span>btn_sec)</code></pre>
<p>A difference at the weights calculation is next, which sums the beaten margin in lbs and the difference in weight carried (<code>pounds</code> in the dataset). To use this function the dataset should be grouped into individual races (it already has been when the dataset was first reduced), and arranged by finishing position (<code>place</code> variable in the dataset). A quick look to check everything looks grouped and in order.</p>
<pre class="sourceCode r"><code class="sourceCode r">races %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">arrange</span>(place) %&gt;%
<span class="st">    </span><span class="kw">select</span>(race_date, race_time, track, place, horse_name, fintime, btn_lbs)</code></pre>
<pre><code>## Source: local data frame [12,417 x 7]
## Groups: race_date, race_time, track
## 
##     race_date race_time     track place          horse_name fintime
## 1  2000-03-23  14:05:00 Doncaster     1       Nearly A Fool   60.55
## 2  2000-03-23  14:05:00 Doncaster     2 Shoeshine Boy (IRE)   60.85
## 3  2000-03-23  14:05:00 Doncaster     3         Millys Lass   61.00
## 4  2000-03-23  14:05:00 Doncaster     4     Viscount Bankes   61.25
## 5  2000-03-23  14:05:00 Doncaster     5   Sir Francis (IRE)   61.35
## 6  2000-03-23  14:05:00 Doncaster     6           Magic Box   61.38
## 7  2000-03-23  14:05:00 Doncaster     7      Quizzical Lady   61.53
## 8  2000-03-23  14:05:00 Doncaster     8     Bold McLaughlan   61.68
## 9  2000-03-23  14:05:00 Doncaster     9    Midnight Venture   61.71
## 10 2000-03-23  14:05:00 Doncaster    10   Densim Blue (IRE)   62.06
## ..        ...       ...       ...   ...                 ...     ...
## Variables not shown: btn_lbs (dbl)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">races %&lt;&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">arrange</span>(place) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">diff_wgts =</span> <span class="kw">diff_at_wgts</span>(<span class="dt">btn_lbs =</span> btn_lbs, <span class="dt">wgt_carried =</span> pounds))</code></pre>
</div>
<div id="initialising-a-handicap" class="section level4">
<h4>Initialising a Handicap</h4>
<p>With the differance at the weights calculated, I will show the use of <strong>RcappeR</strong>’s <code>zipf_init</code> and <code>zipf_hcp</code> with a subset of races that belong to Class 1 or 2 (<code>race_class</code> variable). I will also extract one race from this subset that will be used to show <code>zipf_hcp</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">subset_races &lt;-<span class="st"> </span>races %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(race_class %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Class 1&quot;</span>, <span class="st">&quot;Class 2&quot;</span>)) %&gt;%
<span class="st">    </span><span class="kw">ungroup</span>()

<span class="co"># the race to be extracted is the Zetland Stakes</span>
zetland_stakes &lt;-<span class="st"> </span>subset_races %&gt;%<span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;Zetland Stakes&quot;</span>, race_name, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))
<span class="co"># it is also removed from the subsetted races</span>
subset_races %&lt;&gt;%<span class="st"> </span><span class="kw">filter</span>(!<span class="kw">grepl</span>(<span class="st">&quot;Zetland Stakes&quot;</span>, race_name, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>))</code></pre>
<p>First to initialise a handicap using <code>zipf_init</code>, which requires a dataset of unique races that have been prepared as above, ie. culminating in a difference at the weights calculation. The <code>zipf_init</code> function takes 4 parameters, the first param is our <code>subset_races</code>, the second is how to group the races so each group contains races of a similar type or class (ie <code>race_class</code>), the third is a way to identify the unique races (ie <code>race_date</code>, <code>race_time</code> and <code>track</code>), the final param is the difference at the weights value (<code>diff_wgts</code>). An optional fifth param is for <code>plyr</code>’s progress bar (not entered here).</p>
<pre class="sourceCode r"><code class="sourceCode r">hcp &lt;-<span class="st"> </span><span class="kw">zipf_init</span>(<span class="dt">races =</span> subset_races, <span class="dt">group_by =</span> <span class="st">&quot;race_class&quot;</span>, <span class="dt">race_id =</span> <span class="kw">c</span>(<span class="st">&quot;race_date&quot;</span>, <span class="st">&quot;race_time&quot;</span>, <span class="st">&quot;track&quot;</span>), <span class="dt">btn_var =</span> <span class="st">&quot;diff_wgts&quot;</span>)</code></pre>
<p>The <code>zipf_init</code> function returns a list of class rcapper_zipf_init which has print, summary, and plot S3 methods (although print and summary produce the same output, which could be improved).</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(hcp)</code></pre>
<pre><code>## Initial handicap using zipf_init:
## 
## No. of races:
##   120 
## Race Groups:
##   Class 1, Class 2 
## Counts:
## Class 1 Class 2 
##      64      56 
## 
## Ratings Summary:
##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## -11.5800  -4.9040  -0.6394   0.0000   2.4760  25.2000</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(hcp)</code></pre>
<p><img src="wild_data_example_files/figure-html/unnamed-chunk-18-1.png" title="" alt="" width="480" style="display: block; margin: auto;" /></p>
<p>The plot shows a zipf_rtg for winners per group, for a full explanation about how a rating is calculated see the <a href="http://durtal.github.io/RcappeR/handicap_with_zipf_race.html">zipf_race</a> vignette.</p>
<p>In short those winners who have beaten their rivals by larger difference at the weights will be awarded a higher zipf_rtg than those who narrowly beat rivals. Each race in a group is assessed using the other races in the same group, so a race in Class 1 was assessed using the other <em>N</em> races in the group, which produces a difference between the winner of one race and the winners of the others. The average will always be zero (or very close to zero).</p>
<p>The use of <code>zipf_init</code> only serves as an example here, the second parameter, which groups races together according to a variable the user enters, is very important. Ideally each group should contain horses of a similar ability, so in the UK Class 1 races are contested by better horses than Class 2 races, however, within each class there are likely to be further differences. Class 1 races in this dataset also include Group 1, 2, 3 and Listed races (see the <code>major</code> variable), which are contested by horses of differing abilities. Experience and domain-expertise can help establish rough groups, but unless the number of races is large, then splitting the races into smaller and smaller groups isn’t wise.</p>
<p><code>zipf_init</code>, as it’s name suggests, only initialises a handicap, within each group. The next step is to establish the differences between these groups, ie. the difference between an average winner of a Class 1 race vs a Class 2 race, or the difference between an average Group 1 winner and an average Group 2 winner. A possible solution could be to use existing ratings, in this dataset there is the <code>official_rating</code> variable which is the ratings assigned by the BHA, which could be used as a guide to establish the differences between Class 1 and Class 2, eg:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># copy races dataframe so we can work on it</span>
tmpdf &lt;-<span class="st"> </span>races
<span class="co"># as the dataset contains a lot of 2yo&#39;s a lot of horses have an official_rating of 0, where NA is more appropriate</span>
tmpdf$official_rating[<span class="kw">which</span>(tmpdf$official_rating ==<span class="st"> </span><span class="dv">0</span>)] &lt;-<span class="st"> </span><span class="ot">NA</span>

<span class="co"># now group the races according to race_class and calculate the average official_rating</span>
tmpdf %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(race_class) %&gt;%
<span class="st">    </span><span class="kw">summarise</span>(<span class="dt">avg_rating =</span> <span class="kw">mean</span>(official_rating, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</code></pre>
<pre><code>## Source: local data frame [7 x 2]
## 
##   race_class avg_rating
## 1    Class 1   96.74823
## 2    Class 2   85.78538
## 3    Class 3   79.01458
## 4    Class 4   71.50265
## 5    Class 5   61.46076
## 6    Class 6   53.21881
## 7      Irish   79.53040</code></pre>
<p>The difference in <code>race_class</code> is clear and could be used (temporarily at least) to establish the difference between one group and another. Establishing the differences is a challenge, and the <strong>RcappeR</strong> package can’t offer a solution (at the moment at least).</p>
<p>These ratings found in the <code>hcp</code> list can be merged with the <code>subset_races</code> via the <strong>RcappeR</strong> function <code>merge_zipf_init</code>, which is done now, the function can calculate ratings for all runners by entering the <code>diff_wgts</code> variable into the <code>btn_var</code> param. The average ratings per <code>race_class</code> established above will be used as an example, average Class 1 race winner will be awarded 97, while average Class 2 winner 86.</p>
<p>The code below also subsets Class 1 races that will be used to handicap the Listed race extracted earlier, the Zetland Stakes.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># merge list returned by zipf_init and subset_races</span>
subset_races &lt;-<span class="st"> </span><span class="kw">merge_zipf_init</span>(<span class="dt">zipf_list =</span> hcp, <span class="dt">races =</span> subset_races, <span class="dt">btn_var =</span> <span class="st">&quot;diff_wgts&quot;</span>)

<span class="co"># use average ratings per group</span>
subset_races$zipf_rtg[<span class="kw">which</span>(subset_races$race_class ==<span class="st"> &quot;Class 1&quot;</span>)] &lt;-<span class="st"> </span><span class="dv">97</span> +<span class="st"> </span>subset_races$zipf_rtg[<span class="kw">which</span>(subset_races$race_class ==<span class="st"> &quot;Class 1&quot;</span>)]
subset_races$zipf_rtg[<span class="kw">which</span>(subset_races$race_class ==<span class="st"> &quot;Class 2&quot;</span>)] &lt;-<span class="st"> </span><span class="dv">86</span> +<span class="st"> </span>subset_races$zipf_rtg[<span class="kw">which</span>(subset_races$race_class ==<span class="st"> &quot;Class 2&quot;</span>)]

class1_races &lt;-<span class="st"> </span>subset_races %&gt;%<span class="st"> </span><span class="kw">filter</span>(race_class ==<span class="st"> &quot;Class 1&quot;</span>)</code></pre>
<p>Now to show <code>zipf_hcp</code>, we have a group of races that have been handicapped and ratings calculated, <code>class1_races</code>, and we have a race that requires handicapping <code>zetland_stakes</code>. The <code>zipf_hcp</code> function uses a collection of similar races and their ratings, to calculate potential ratings for the winner of a new, un-rated race.</p>
<pre class="sourceCode r"><code class="sourceCode r">hcp &lt;-<span class="st"> </span><span class="kw">zipf_hcp</span>(<span class="dt">race =</span> zetland_stakes, <span class="dt">past_races =</span> class1_races, <span class="dt">race_id =</span> <span class="kw">c</span>(<span class="st">&quot;race_date&quot;</span>, <span class="st">&quot;race_time&quot;</span>, <span class="st">&quot;track&quot;</span>), <span class="dt">btn_var =</span> <span class="st">&quot;diff_wgts&quot;</span>, <span class="dt">rating =</span> <span class="st">&quot;zipf_rtg&quot;</span>)

<span class="kw">plot</span>(hcp)</code></pre>
<p><img src="wild_data_example_files/figure-html/unnamed-chunk-21-1.png" title="" alt="" width="480" style="display: block; margin: auto;" /></p>
<p>The plot shows a distribution of potential ratings for the winner of the Zetland Stakes, these potential ratings are calculated using each of the races in <code>class1_races</code>, the average rating, 102.1751563 is also shown. As the plot suggests, using more races would likely strengthen the confidence in a rating.</p>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
